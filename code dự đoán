-ThÆ° viá»‡n cáº§n táº£i
!pip install ultralytics tensorflow gradio opencv-python
!pip install gradio

-CODE Dá»° ÄOÃN
import gradio as gr
import cv2
import numpy as np
from ultralytics import YOLO
from tensorflow.keras.models import load_model
from tensorflow.keras.preprocessing.image import img_to_array
from PIL import Image

yolo_model = YOLO("/content/drive/MyDrive/yolov8n.pt")

# Keras .h5 Ä‘á»ƒ phÃ¢n loáº¡i mÃ³n Äƒn
classifier_model = load_model("/content/drive/MyDrive/cantin_model.h5")

# Danh sÃ¡ch nhÃ£n tÆ°Æ¡ng á»©ng vá»›i mÃ´ hÃ¬nh classifier
class_labels = [
    "Ca hu kho", "Canh cai", "Canh chua", "Com trang", "Dau hu sot ca",
    "Ga chien", "Rau muong xao", "Thit kho", "Thit kho trung", "Trung chien"
]

# Báº£ng giÃ¡ mÃ³n Äƒn
food_prices = {
    "Ca hu kho": 10000,
    "Canh cai": 8000,
    "Canh chua": 8000,
    "Com trang": 5000,
    "Dau hu sot ca": 7000,
    "Ga chien": 12000,
    "Rau muong xao": 6000,
    "Thit kho": 12000,
    "Thit kho trung": 14000,
    "Trung chien": 7000
}

def preprocess_crop(crop_img):
    img = cv2.resize(crop_img, (128, 128))
    img = img.astype("float32") / 255.0
    img = np.expand_dims(img, axis=0)
    return img

def detect_and_classify(image):
    results = yolo_model(image)
    detections = results[0].boxes.data.cpu().numpy()

    predicted_classes = []
    total_price = 0

    for det in detections:
        x1, y1, x2, y2, score, class_id = det
        if score < 0.3:
            continue

        crop = image[int(y1):int(y2), int(x1):int(x2)]
        if crop.size == 0:
            continue

        # Tiá»n xá»­ lÃ½ vÃ  phÃ¢n loáº¡i báº±ng CNN
        input_img = preprocess_crop(crop)
        preds = classifier_model.predict(input_img)
        predicted_index = np.argmax(preds[0])
        predicted_label = class_labels[predicted_index]

        predicted_classes.append(predicted_label)
        total_price += food_prices.get(predicted_label, 0)

    if not predicted_classes:
        return image, "<span style='color:red'>KhÃ´ng phÃ¡t hiá»‡n Ä‘Æ°á»£c mÃ³n Äƒn!</span>", "0 Ä‘"

    result_html = "".join([
        f"<li>{label}: {food_prices[label]:,} Ä‘</li>" for label in predicted_classes
    ])
    return image, f"<ul>{result_html}</ul>", f"{total_price:,} Ä‘"

# === Giao diá»‡n Gradio ===
header = """
<div style="text-align:center; padding: 20px;">
    <h1 style="color:#2E8B57">ğŸ± Nháº­n Diá»‡n MÃ³n Ä‚n & TÃ­nh Tiá»n</h1>
    <p>Táº£i áº£nh mÃ¢m cÆ¡m lÃªn Ä‘á»ƒ phÃ¡t hiá»‡n vÃ  tÃ­nh giÃ¡ cÃ¡c mÃ³n Äƒn</p>
</div>
"""

with gr.Blocks(theme=gr.themes.Soft()) as demo:
    gr.HTML(header)
    with gr.Row():
        with gr.Column():
            image_input = gr.Image(type="numpy", label="ğŸ“· áº¢nh mÃ¢m cÆ¡m")
            btn = gr.Button("ğŸ” Nháº­n diá»‡n & tÃ­nh tiá»n")
        with gr.Column():
            image_output = gr.Image(type="numpy", label="áº¢nh káº¿t quáº£")
            food_list = gr.HTML(label="ğŸ½ï¸ Danh sÃ¡ch mÃ³n Äƒn")
            total_cost = gr.Textbox(label="ğŸ’° Tá»•ng tiá»n")

    btn.click(fn=detect_and_classify, inputs=image_input, outputs=[image_output, food_list, total_cost])
# Cháº¡y á»©ng dá»¥ng
demo.launch()
